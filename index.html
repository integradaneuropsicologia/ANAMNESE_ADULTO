<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Anamnese ‚Äì Vers√£o Adulta</title>
<style>
  :root{
    --bg:#0f172a;
    --card:#111827;
    --card-soft:#0b1220;
    --field:#0a0f1c;
    --line:#1f2937;
    --text:#e5e7eb;
    --muted:#94a3b8;
    --pri:#4f46e5;
    --ok:#22c55e;
    --err:#ef4444;
  }

  /* Tema claro */
  :root[data-theme="light"]{
    --bg:#f3f4f6;
    --card:#ffffff;
    --card-soft:#f9fafb;
    --field:#ffffff;
    --line:#d1d5db;
    --text:#020617;
    --muted:#4b5563;
    --pri:#4f46e5;
    --ok:#16a34a;
    --err:#dc2626;
  }

  *{box-sizing:border-box}
  body{
    margin:0;
    background:var(--bg);
    color:var(--text);
    font:16px/1.5 system-ui,-apple-system,Segoe UI,Roboto;
  }
  .wrap{max-width:1000px;margin:24px auto;padding:0 16px}
  .card{
    background:var(--card);
    border:1px solid var(--line);
    border-radius:14px;
    padding:18px;
  }

  .head{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:6px;
  }

  h1{margin:0;font-size:1.35rem}
  .muted{color:var(--muted)}

  .grid-info{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin:12px 0 6px
  }
  @media(max-width:720px){
    .grid-info{grid-template-columns:1fr}
  }
  .info{
    background:var(--card-soft);
    border:1px solid var(--line);
    border-radius:10px;
    padding:10px
  }
  .info b{display:block;margin-bottom:4px;color:#cbd5e1}

  .q{
    border:1px solid var(--line);
    border-radius:12px;
    padding:12px;
    background:var(--card-soft);
    margin-bottom:10px
  }
  .q h3{margin:0 0 8px;font-size:1rem}

  textarea{
    width:100%;
    min-height:80px;
    resize:vertical;
    border-radius:10px;
    border:1px solid var(--line);
    background:var(--field);
    color:var(--text);
    padding:10px
  }
  .hint{font-size:.9rem;color:#9fb2cc;margin-bottom:8px}

  .opts{display:flex;flex-wrap:wrap;gap:10px}
  label.opt{
    display:flex;
    align-items:center;
    gap:8px;
    padding:8px 12px;
    border:1px solid var(--line);
    border-radius:10px;
    cursor:pointer
  }
  .opt input[type="radio"],
  .opt input[type="checkbox"]{
    accent-color:var(--pri)
  }
  label.opt:has(input[type="radio"]:checked),
  label.opt:has(input[type="checkbox"]:checked){
    background:var(--pri);
    border-color:var(--pri);
    color:#fff;
  }
  label.opt:has(input[type="radio"]:checked) span,
  label.opt:has(input[type="checkbox"]:checked) span{
    color:#fff;
    font-weight:600;
  }

  .btn{
    display:inline-flex;
    align-items:center;
    gap:8px;
    background:var(--pri);
    border:none;
    color:#fff;
    padding:10px 14px;
    border-radius:10px;
    cursor:pointer
  }
  .btn.ok{background:var(--ok)}
  .btn:disabled{opacity:.6;cursor:not-allowed}

  .btn-theme{
    border-radius:999px;
    border:1px solid var(--line);
    background:transparent;
    color:var(--muted);
    padding:6px 10px;
    cursor:pointer;
    font-size:.85rem;
    display:inline-flex;
    align-items:center;
    gap:6px;
  }

  .msg{margin:10px 0;padding:10px;border-radius:8px}
  .okbox{background:#052e1a;border:1px solid #114d2a;color:#b3f7c1}
  .errbox{background:#3b0d0d;border:1px solid #5b1919;color:#ffd0d0}
  .warnbox{background:#3a2903;border:1px solid #5c4307;color:#ffe6b0}

  .legend{
    background:var(--card-soft);
    border:1px dashed var(--line);
    border-radius:10px;
    padding:10px;
    margin:6px 0 12px
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <div class="head">
      <h1>Anamnese ‚Äì Vers√£o Adulta</h1>
      <button type="button" id="toggleTheme" class="btn-theme" aria-label="Alternar tema claro/escuro">
        <span id="themeIcon">üåô</span>
        <span id="themeLabel">Tema</span>
      </button>
    </div>

    <!-- Dados do paciente (por token) -->
    <div id="pacInfo" class="grid-info" style="display:none;"></div>

    <form id="form" style="margin-top:14px; display:none;">
      <div id="qs"></div>

      <div class="legend muted">
        Dica: escreva livremente; o rascunho √© salvo automaticamente neste dispositivo.
      </div>

      <div style="margin-top:14px;display:flex;gap:8px;align-items:center">
        <button id="btnSubmit" class="btn ok" type="submit">Enviar anamnese</button>
        <div id="progress" class="muted"></div>
      </div>
      <div id="msg" class="msg" style="display:none"></div>
    </form>

    <div id="alert" class="msg" style="display:none"></div>
  </div>
</div>

<script>
// ======== CONFIG ========
const SHEETDB_BASE = "https://sheetdb.io/api/v1/8pmdh33s9fvy8";
const SHEETS = { PATIENTS:"Patients", TOKENS:"LinkTokens", SCORES:"Scores_ANAMNESE_ADULTO" };
const CODE = "ANAMNESE_ADULTO";
const PORTAL_URL = "https://integradaneuropsicologia.github.io/formularios/";
const THEME_KEY = "INTEGRADA_THEME";

// ======== HELPERS ========
const $ = s => document.querySelector(s);
const onlyDigits = s => (s||"").replace(/\D+/g,"");
const qs = k => new URLSearchParams(location.search).get(k) || "";
const AUTOSAVE_KEY = `${CODE}_${qs("token")||"no_token"}`;

// texto 1 linha (pra n√£o quebrar PDF)
const sanitizeOneLine = t => (t||"").replace(/\s+/g," ").trim();

function setBox(id, text, kind="ok"){
  const el=$(id); if(!el) return;
  el.textContent=text;
  el.className="msg "+(kind==="ok"?"okbox":kind==="warn"?"warnbox":"errbox");
  el.style.display="block";
}
function hideBox(id){
  const el=$(id);
  if(el){ el.style.display="none"; el.textContent=""; }
}
function maskCPF(cpf){
  const d=onlyDigits(cpf||"");
  if(d.length!==11) return cpf||"";
  return `${d.slice(0,3)}.${d.slice(3,6)}.${d.slice(6,9)}-${d.slice(9)}`;
}
function fmtDateISO(iso){
  if(!iso) return "";
  const [y,m,d]=iso.split("-");
  return (y&&m&&d)?`${d}/${m}/${y}`:iso;
}
async function GET(url){
  const r=await fetch(url);
  if(!r.ok) throw new Error("HTTP "+r.status);
  return r.json();
}
async function POST(url, body){
  const r=await fetch(url,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function PATCH(url, body){
  const r=await fetch(url,{
    method:"PATCH",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify(body)
  });
  if(!r.ok) throw new Error(await r.text());
  return r.json();
}
async function sheetSearch(sheet, params){
  const usp=new URLSearchParams(params);
  return GET(`${SHEETDB_BASE}/search?sheet=${encodeURIComponent(sheet)}&${usp.toString()}`);
}
async function sheetCreate(sheet, row){
  return POST(`${SHEETDB_BASE}?sheet=${encodeURIComponent(sheet)}`, { data:[row] });
}
async function sheetPatchBy(sheet, column, value, data){
  return PATCH(`${SHEETDB_BASE}/${encodeURIComponent(column)}/${encodeURIComponent(value)}?sheet=${encodeURIComponent(sheet)}`, { data });
}
function goPortalWithToken(){
  const TOKEN=qs("token");
  try{
    const u=new URL(PORTAL_URL,location.href);
    u.searchParams.set("token",TOKEN);
    location.href=u.toString();
  }catch(_){
    const sep=PORTAL_URL.includes("?")?"&":"?";
    location.href=PORTAL_URL+sep+"token="+encodeURIComponent(TOKEN);
  }
}

// ======== TEMA CLARO/ESCURO ========
function applyTheme(theme){
  const root = document.documentElement;
  if(theme === "light"){
    root.setAttribute("data-theme","light");
  }else{
    root.removeAttribute("data-theme"); // dark padr√£o
    theme = "dark";
  }
  const icon = $("#themeIcon");
  const label = $("#themeLabel");
  if(icon){
    icon.textContent = theme === "light" ? "‚òÄÔ∏è" : "üåô";
  }
  if(label){
    label.textContent = theme === "light" ? "Claro" : "Escuro";
  }
}

function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const prefersLight = window.matchMedia && window.matchMedia("(prefers-color-scheme: light)").matches;
  const theme = saved || (prefersLight ? "light" : "dark");
  applyTheme(theme);
}

// chama imediatamente (script est√° no final do body)
initTheme();
const themeBtn = $("#toggleTheme");
if(themeBtn){
  themeBtn.addEventListener("click", ()=>{
    const isLight = document.documentElement.getAttribute("data-theme")==="light";
    const next = isLight ? "dark" : "light";
    localStorage.setItem(THEME_KEY, next);
    applyTheme(next);
  });
}

// ======== PERGUNTAS ========
// Escalas padr√£o
const FREQ5   = ["Nunca","Raramente","√Äs vezes","Frequentemente","Quase sempre","N√£i sei/N√£o se aplica"];
const SEVER4  = ["N√£o","Leve","Moderada","Grave","N√£i sei/N√£o se aplica"];
const YESNO   = ["Sim","N√£o","N√£i sei/N√£o se aplica"];
const YNP     = ["Sim","N√£o","N√£i sei/N√£o se aplica"];

const QUESTIONS = [
  // ‚Äî‚Äî‚Äî CONTEXTO ‚Äî‚Äî‚Äî

  { type: "checkbox", section: "Contexto", text: "Justificativa dessa avalia√ß√£o", options: ["Abuso sexual infantil", "Atraso cognitivo na prematuridade", "Problemas de comunica√ß√£o e intera√ß√£o social", "Queixa cognitiva na epilepsia ", "Queixas cognitivas no idoso", "Dificuldades escolares e problemas de comportamento", "problemas de aten√ß√£o e mem√≥ria da vida adulta", "Queixa cognitiva relacionada com o uso de √°lcool"] },

  { type: "checkbox", section: "Contexto", text: "Quais sintomas voc√™ observa. Marque quantos forem necess√°rios.", options: ["Agita√ß√£o", "Agressividade f√≠sica", "Agressividade verbal", "Altera√ß√£o de humor", "Altera√ß√µes fonarticulat√≥rias", "Alto rendimento acad√™mico", "Alucina√ß√£o", "Andar na ponta dos p√©s", "Ansiedade", "Apatia", "Atraso no desenvolvimento da linguagem", "Atraso no desenvolvimento motor", "Atraso nos marcos do desenvolvimento", "Aumento da sensibilidade a est√≠mulos", "Autor de bullying", "Baixa toler√¢ncia √† frustra√ß√£o", "Baixo desempenho escolar", "Choro excessivo", "Comportamento de acumula√ß√£o", "Comportamento de anorexia", "Comportamento de bulimia", "Comportamento de mentir", "Comportamento de roubo", "Comportamento delinquente", "Comportamento desafiador", "Comportamento disruptivo", "Comportamento infantilizado", "Comportamento opositor", "Comportamento repetitivo", "Comportamento sedutor", "Compras excessivas", "Compuls√£o alimentar", "Conflito Interpessoal", "Coordena√ß√£o motora fr√°gil", "Crises de p√¢nico", "Criticidade agu√ßada", "Culpabiliza√ß√£o", "Del√≠rios", "Depend√™ncia", "Depend√™ncia na rela√ß√£o emocional", "Depress√£o", "Desaten√ß√£o", "Desinteresse escolar", "Desobedi√™ncia", "Desorganiza√ß√£o", "Desregula√ß√£o emocional", "Dificuldade de adapta√ß√£o", "Dificuldade de compreens√£o de texto", "Dificuldade de controle inibit√≥rio", "Dificuldade de intera√ß√£o social", "Dificuldade na alfabetiza√ß√£o", "Dificuldade para seguir regras", "Dificuldade para tomada de decis√£o", "Dificuldades motoras", "Dificuldades para acordar", "Dificuldades para adormecer", "Diminu√≠da sensibilidade a est√≠mulos", "Disautonomia", "Ecolalia", "Enurese diurna", "Enurese noturna", "Esteriotipias", "Facilidade na aprendizagem", "Fala infantilizada", "Fala sozinho", "Falta de planejamento", "Flapping", "Hiperfoco", "Impulsividade", "Indisciplina", "Ingenuidade", "Inquieta√ß√£o", "Insatisfa√ß√£o com a imagem corporal", "Intercorr√™ncias no sono", "Irritabilidade", "Ju√≠zo cr√≠tico comprometido", "Limita√ß√µes motoras", "Luto", "Mania de limpeza", "Mania de organiza√ß√£o", "Mutismo", "N√£o sabe brincar", "Pensamento acelerado", "Perda capacidade visual", "Perda da capacidade auditiva", "Pouco contato visual", "Problemas de aprendizagem de escrita", "Problemas de aprendizagem de leitura", "Problemas de aprendizagem de matem√°tica", "Problemas de mem√≥ria", "Problemas de racioc√≠nio", "Problemas na compreens√£o da leitura", "Procrastina√ß√£o", "Recusa alimentar", "Repet√™ncia escolar", "Rigidez de comportamento", "Rigidez de pensamento", "Seletividade alimentar", "Sono improdutivo", "Teimosia", "Tiques", "Uso abusivo de subst√¢ncias psicoativas", "Uso excessivo de telas", "V√≠tima de abuso sexual", "V√≠tima de abuso verbal", "V√≠tima de aliena√ß√£o parental", "V√≠tima de bullying"
] },

  { type: "checkbox", section: "Contexto", text: "Quais contextos s√£o impactados pela sua demanda?", options: ["Casa","Trabalho","Escola/Faculdade","Social","Outros"] },
  
  { type: "checkbox", section: "Contexto", text: "Solicitantes do laudo?", options: ["Banca de concurso", "Conselho Tutelar", "Defensoria P√∫blica", "Delegacia", "Demanda espont√¢nea", "Demanda espont√¢nea dos familiares", "Equipe Jur√≠dica", "Escola", "Fisioterapeuta", "Fonoaudi√≥loga", "M√©dica Sex√≥loga", "M√©dico Cl√≠nico Geral", "M√©dico Endocrinologista", "M√©dico Geneticista", "M√©dico Geriatra", "M√©dico Neurocirurgi√£o", "M√©dico Neurologista", "M√©dico Neuropediatra", "M√©dico Pediatra", "M√©dico Psiquiatra", "Minist√©rio P√∫blico", "Musicoterapeuta", "Prefeitura", "Psicomotricista", "Psicopedagoga", "Psicoterapeuta", "Terapeuta Ocupacional", "Tribunal de Justi√ßa", "Vara da Inf√¢ncia e da Juventude"

  ]},
  { type: "checkbox", section: "Contexto", text: "Finalidade do laudo", options: [
    "Avalia√ß√£o longitudinal", "Avalia√ß√£o Multidisciplinar", "Avalia√ß√£o para autoriza√ß√£o cir√∫rgica", "Avalia√ß√£o pr√©-cir√∫rgica", "Avalia√ß√£o psicol√≥gica no contexto carcer√°rio para atender demandas judiciais", "Avalia√ß√£o psicol√≥gica para candidatos √† obten√ß√£o de Carteira Nacional de Habilita√ß√£o", "Avalia√ß√£o psicol√≥gica para manuseio de arma de fogo", "Avalia√ß√£o Psicossocial", "Delineamento de perfil neuropsicol√≥gico", "Diagn√≥stico diferencial", "Direcionamento de condutas escolares", "Direcionamento de condutas terap√™uticas", "Per√≠cia psicol√≥gica", "Valida√ß√£o de estado psicol√≥gico para ingresso em concurso p√∫blico"

  ]},
  { type: "checkbox", section: "Contexto", text: "Motivo da avalia√ß√£o", options: [
    "TCE (traumatismo craniano)","Dificuldades escolares/profissionais e comportamento",
    "Condi√ß√£o neurol√≥gica (ex.: cisto aracnoide, polimicrogiria, ventriculomegalia)",
    "Epilepsia com queixa cognitiva","Uso de √°lcool com queixa cognitiva",
    "Queixas cognitivas no idoso","Tumor cerebral com queixa cognitiva",
    "Craniofaringioma","Problemas de aten√ß√£o e mem√≥ria no adulto",
    "Problemas de intera√ß√£o e comunica√ß√£o social","Suspeita de aliena√ß√£o parental"
  ]},
  {type: "checkbox", section: "Contexto", text: "Lateralidade", options: ["Destro", "Canhoto", "Ambidestro"]},
  {type: "checkbox", section: "Contexto", text: "Estado civil", options: ["Solteiro(a)", "Casado(a)", "Uni√£o est√°vel", "Divorciado(a)", "Separado(a)", "Vi√∫vo(a)", "Namorando", "Relacionamento aberto", "Outro"
]},
{type: "checkbox", section: "Contexto", text: "Escolaridade", options: ["Educa√ß√£o infantil", "Ensino fundamental incompleto", "Ensino fundamental completo", "Ensino m√©dio incompleto", "Ensino m√©dio completo", "Ensino t√©cnico incompleto", "Ensino t√©cnico completo", "Ensino superior incompleto", "Ensino superior completo", "P√≥s-gradua√ß√£o", "Mestrado", "Doutorado", "P√≥s-doutorado"
]},
 {type: "checkbox", section: "Contexto", text: "Tipo de escola", options: ["P√∫blica", "Particular"]},

  // ‚Äî‚Äî‚Äî SINAIS (GERAL) ‚Äî‚Äî‚Äî
  { type: "checkbox", section: "Sinais (geral)", text: "Agita√ß√£o (n√£o fica quieto)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Agressividade verbal (gritos/xingamentos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Agressividade f√≠sica (empurrar/bater/lan√ßar objetos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Oscila√ß√£o de humor no mesmo dia", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Ansiedade (preocupa√ß√£o, tens√£o, inquieto)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Crises de p√¢nico (in√≠cio s√∫bito, sintomas f√≠sicos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Apatia / perda de interesse", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Habilidades acima da m√©dia (linguagem, matem√°tica, aprendizagem, outras)", options: ["N√£o","Sim ‚Äî linguagem","Sim ‚Äî matem√°tica","Sim ‚Äî aprendizagem","Sim ‚Äî outras √°reas"] },

  { type: "checkbox", section: "Sinais (geral)", text: "Desempenho no trabalho/estudos abaixo do esperado (mantido no tempo)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Acumula objetos / dificuldade de descartar", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Comportamento alimentar de risco", options: [
    "Nenhum","Restri√ß√£o/medo de engordar (anorexia)","Compuls√£o + compensa√ß√£o (bulimia)","Compuls√£o sem compensa√ß√£o"
  ]},

  { type: "checkbox", section: "Sinais (geral)", text: "Roubo/furto (casa, trabalho, lojas)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Opositor/desafiador com autoridade", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Disruptivo (quebra regras do ambiente)", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Comportamentos repetitivos/estereotipias", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Compras em excesso com perda de controle", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Sensibilidade incomum a est√≠mulos", options: [
    "Som","Luz","Toque/tecidos","Cheiros","Texturas/alimentos","Hipo-reativo √† dor","Sem altera√ß√µes"
  ]},

  { type: "checkbox", section: "Sinais (geral)", text: "Baixa toler√¢ncia √† frustra√ß√£o", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Choro dif√≠cil de controlar", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Mentiras repetidas com preju√≠zo social", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Condutas delituosas (vandalismo/infra√ß√µes)", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Conflitos com fam√≠lia/colegas/chefia", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Culpa em excesso por coisas pequenas", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Depend√™ncia de outros (decis√µes/tarefas/emocional)", options: ["N√£o","Sim ‚Äî decis√µes","Sim ‚Äî tarefas","Sim ‚Äî emocional"] },
  { type: "checkbox", section: "Sinais (geral)", text: "Humor deprimido / anedonia", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Desaten√ß√£o no dia a dia (‚â•2 contextos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Desorganiza√ß√£o de materiais, prazos e rotinas", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Dificuldade para se adaptar a mudan√ßas", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Age sem pensar (controle inibit√≥rio baixo)", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Coordena√ß√£o motora fr√°gil", options: SEVER4 },
  { type: "checkbox", section: "Sinais (geral)", text: "Criticidade/inflexibilidade em opini√µes", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Del√≠rios (ideias falsas fixas)", options: ["N√£o","Persegui√ß√£o","Grandeza","Ci√∫me","Culpa","Refer√™ncia","Outras"] },
  { type: "checkbox", section: "Sinais (geral)", text: "Desobedi√™ncia a regras combinadas", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Desregula√ß√£o emocional (explode/dificulta acalmar)", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Dificuldade nas rela√ß√µes (conversa, amizades)", options: SEVER4 },
  { type: "checkbox", section: "Sinais (geral)", text: "Dificuldade para seguir passos/regras em sequ√™ncia", options: SEVER4 },
  { type: "checkbox", section: "Sinais (geral)", text: "Dificuldade para decidir (trava na escolha)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî SONO ‚Äî‚Äî‚Äî
  { type: "checkbox", section: "Sono", text: "Dificuldade para acordar no hor√°rio", options: FREQ5 },
  { type: "checkbox", section: "Sono", text: "Dificuldade para adormecer/manter o sono", options: FREQ5 },
  { type: "checkbox", section: "Sono", text: "Sono n√£o reparador (acorda cansado)", options: FREQ5 },

  // ‚Äî‚Äî‚Äî OUTROS SINAIS ‚Äî‚Äî‚Äî
  { type: "checkbox", section: "Sinais (geral)", text: "Falar sozinho em p√∫blico/em excesso", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Ingenuidade (cai f√°cil em golpes/enganos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Dificuldades motoras que limitam tarefas", options: SEVER4 },
  { type: "checkbox", section: "Sinais (geral)", text: "Falta de planejamento para tarefas em etapas", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Hiperfoco (fica horas no mesmo interesse)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Indisciplina em ambientes com regras", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Inquieta√ß√£o (levanta, mexe m√£os/p√©s)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Insatisfa√ß√£o com a imagem corporal", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Irritabilidade (pavio curto)", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Mania de limpeza (rituais, muito tempo nisso)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Mania de organiza√ß√£o r√≠gida", options: FREQ5 },

  { type: "checkbox", section: "Sinais (geral)", text: "Mutismo (n√£o fala em certos contextos)", options: FREQ5 },
  { type: "checkbox", section: "Sinais (geral)", text: "Pensamento acelerado (dif√≠cil desacelerar)", options: FREQ5 },

  { type: "checkbox", section: "Percep√ß√£o", text: "Alucina√ß√µes (ouvir/ver/cheiros/t√°til)", options: ["Nunca","Auditivas","Visuais","Olfativas","T√°teis"] },
  { type: "checkbox", section: "Percep√ß√£o", text: "Perda de audi√ß√£o (relato/exame)", options: YNP },
  { type: "checkbox", section: "Percep√ß√£o", text: "Perda de vis√£o (relato/exame)", options: YNP },
  { type: "checkbox", section: "Cl√≠nico", text: "Sinais de disautonomia (tontura/s√≠ncope/intoler√¢ncia ortost√°tica)", options: YNP },

  { type: "checkbox", section: "Prote√ß√£o", text: "Situa√ß√µes de viol√™ncia/abuso", options: ["Nenhuma","Abuso sexual","Abuso verbal/psicol√≥gico","Bullying","Aliena√ß√£o parental","Outros"] },

  // ‚Äî‚Äî‚Äî APRENDIZAGEM/ESTUDOS (se aplic√°vel) ‚Äî‚Äî‚Äî
  { type: "checkbox", section: "Aprendizagem", text: "Leitura ‚Äî dificuldades atuais", options: ["N√£o","Decodifica√ß√£o (trocas)","Flu√™ncia (lento/perde linha)","Compreens√£o (n√£o entende/infere)","Outras dificuldades"] },
  { type: "checkbox", section: "Aprendizagem", text: "Escrita ‚Äî dificuldades atuais", options: ["N√£o","Ortografia (trocas/omiss√µes)","Texto (coes√£o/coer√™ncia)","Velocidade/legibilidade","Outras dificuldades"] },
  { type: "checkbox", section: "Aprendizagem", text: "Matem√°tica ‚Äî dificuldades atuais", options: ["N√£o","Fatos (tabuada)","C√°lculo (com/sem suporte)","Problemas (texto/interpreta√ß√£o)","Outras dificuldades"] },

  // ‚Äî‚Äî‚Äî TRIAGENS ‚Äî‚Äî‚Äî
  // DI
  { type: "checkbox", section: "Triagem ‚Äî DI", text: "Dificuldade para aprender/raciocinar/planejar", options: YNP },
  { type: "checkbox", section: "Triagem ‚Äî DI", text: "Entende e usa ideias abstratas (tempo, dinheiro, regras sociais)", options: ["Sim","Parcialmente","N√£o","N√£o sei"] },
  { type: "checkbox", section: "Triagem ‚Äî DI", text: "Precisa de ajuda nas atividades do dia a dia", options: ["N√£o","Ajuda √†s vezes","Ajuda frequente","Ajuda o tempo todo","N√£o sei"] },
  { type: "checkbox", section: "Triagem ‚Äî DI", text: "Adapta-se bem em casa/trabalho/vida social", options: ["Sim","Parcialmente","N√£o","N√£o sei"] },
  { type: "checkbox", section: "Triagem ‚Äî DI", text: "As dificuldades de aprendizagem come√ßaram na inf√¢ncia", options: YNP },

  // Pragm√°tica
  { type: "checkbox", section: "Triagem ‚Äî Pragm√°tica", text: "Ajusta a fala conforme a situa√ß√£o (amigo x chefe/professor)", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî Pragm√°tica", text: "Mant√©m conversas (turnos, manter assunto, n√£o sair do contexto)", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî Pragm√°tica", text: "Entende piadas, ironias e duplo sentido", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî Pragm√°tica", text: "As dificuldades atrapalham vida social/estudo/trabalho", options: YNP },

  // TEA
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Dificuldade em contato social (olhar, iniciar/responder intera√ß√µes)", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Comunica√ß√£o verbal/n√£o verbal diferente ou limitada", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Interesses restritos/comportamentos repetitivos", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Rotinas r√≠gidas / sofre com mudan√ßas", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Rea√ß√µes incomuns a sons/luzes/texturas/cheiros", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Sinais presentes desde a inf√¢ncia", options: YNP },
  { type: "checkbox", section: "Triagem ‚Äî TEA", text: "Conjunto dos sintomas causa preju√≠zo importante", options: YNP },

  // TDAH ‚Äî Desaten√ß√£o
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Erros por descuido / n√£o presta aten√ß√£o em detalhes", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Dificuldade para manter a aten√ß√£o em tarefas/atividades", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Parece n√£o escutar quando falam diretamente", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "N√£o segue instru√ß√µes / deixa tarefas inacabadas", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Dificuldade para organizar tarefas, materiais e rotina", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Evita tarefas longas que exigem esfor√ßo mental", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Perde coisas com frequ√™ncia (chaves, material, celular)", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Distrai-se f√°cil com est√≠mulos externos/pensamentos", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Desaten√ß√£o)", text: "Esquece compromissos/tarefas do dia a dia", options: FREQ5 },

  // TDAH ‚Äî Hiperatividade/Impulsividade
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Mexer m√£os/p√©s / remexer na cadeira", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Levanta quando deveria ficar sentado", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Inquieta√ß√£o intensa (ou correr/subir em lugares inadequados)", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Dificuldade para participar de forma calma", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Parece estar ‚Äúa mil‚Äù / ‚Äúligado no 220‚Äù", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Fala em excesso", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Responde antes da pergunta terminar / interrompe", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Dificuldade para esperar a vez", options: FREQ5 },
  { type: "checkbox", section: "Triagem ‚Äî TDAH (Hiper/Impulso)", text: "Intromete-se nas atividades/conversas dos outros", options: FREQ5 },

  // ‚Äî‚Äî‚Äî TELAS & SUBST√ÇNCIAS ‚Äî‚Äî‚Äî
  { type: "checkbox", section: "Uso de telas & subst√¢ncias", text: "Uso excessivo de telas (prejudica sono/estudo/conviv√™ncia)", options: FREQ5 },
  { type: "checkbox", section: "Uso de telas & subst√¢ncias", text: "Uso de subst√¢ncias com preju√≠zo", options: ["N√£o","√Ålcool","Cannabis","Estimulantes","Sedativos/ansiol√≠ticos","Outras"] },
];


const N = QUESTIONS.length;

// ======== RENDER ========
function renderQuestions(){
  const host = $("#qs"); host.innerHTML="";

  QUESTIONS.forEach((q, idx)=>{
    const n = idx+1;
    const qn = String(n).padStart(2,"0");
    const wrap = document.createElement("div");
    wrap.className = "q";

    if (typeof q === "string") {
      wrap.innerHTML = `
        <h3 id="lbl${qn}">${n}. ${q}</h3>
        <textarea name="q${qn}" id="q${qn}" placeholder="Escreva aqui..."></textarea>
      `;
    } else if (q.type === "checkbox") {
      const opts = q.options || [];
      let html = `<h3 id="lbl${qn}">${n}. ${q.text}</h3><div class="opts">`;
      opts.forEach((opt, i)=>{
        const id = `q${qn}_${i}`;
        html += `
          <label class="opt">
            <input type="checkbox" name="q${qn}" id="${id}" value="${opt}">
            <span>${opt}</span>
          </label>`;
      });
      html += `</div>`;
      wrap.innerHTML = html;
    }
    host.appendChild(wrap);
  });

  host.addEventListener("input", e=>{
    if(e.target.tagName==="TEXTAREA"){
      e.target.style.height="auto";
      e.target.style.height=(e.target.scrollHeight+2)+"px";
    }
    updateProg();
    autosaveAnswers();
  });
  host.addEventListener("change", ()=>{
    updateProg();
    autosaveAnswers();
  });

  updateProg();
}

function updateProg(){
  let filled = 0;
  QUESTIONS.forEach((q, idx)=>{
    const qn = `q${String(idx+1).padStart(2,"0")}`;
    if (typeof q === "string") {
      const el = $("#"+qn);
      if(el && el.value.trim()) filled++;
    } else if (q.type === "checkbox") {
      const any = document.querySelectorAll(`input[name="${qn}"]:checked`).length > 0;
      if(any) filled++;
    }
  });
  $("#progress").textContent = `${filled}/${N} respondidas`;
}

// ======== AUTOSAVE ========
function autosaveAnswers(){
  const answers = {}, qaPairs = [];
  let answeredCount = 0;

  QUESTIONS.forEach((q, idx)=>{
    const n = idx+1;
    const qn = `q${String(n).padStart(2,"0")}`;
    const label = QUESTIONS[idx].text || QUESTIONS[idx];

    if (typeof q === "string") {
      const el = $("#"+qn);
      const val = (el?.value||"").trim();
      answers[qn] = val;
      const clean = sanitizeOneLine(val);
      if(clean) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${clean || "(sem resposta)"}`);
    } else if (q.type === "checkbox") {
      const vals = Array.from(document.querySelectorAll(`input[name="${qn}"]:checked`)).map(el=>el.value);
      answers[qn] = vals;
      const cleanVals = vals.map(v=>sanitizeOneLine(v));
      if(cleanVals.length) answeredCount++;
      qaPairs.push(`${n}. ${label}: ${cleanVals.length ? cleanVals.join(", ") : "(nenhuma op√ß√£o marcada)"}`);
    }
  });

  // string consolidada (mesmo padr√£o do envio, mas s√≥ para debug local)
  const categoria = qaPairs.join(" | ");
  // salva s√≥ answers no storage (suficiente pro rascunho)
  localStorage.setItem(AUTOSAVE_KEY, JSON.stringify({ code: CODE, token: qs("token"), answers }));
}

function restoreAutosave(){
  try{
    const raw = localStorage.getItem(AUTOSAVE_KEY); if(!raw) return;
    const {answers} = JSON.parse(raw)||{}; if(!answers) return;

    Object.entries(answers).forEach(([key,val])=>{
      if(Array.isArray(val)){
        val.forEach(v=>{
          const el = document.querySelector(`input[name="${key}"][value="${v}"]`);
          if(el) el.checked = true;
        });
      }else{
        const el = $("#"+key);
        if(el){
          el.value = val;
          el.style.height="auto";
          el.style.height=(el.scrollHeight+2)+"px";
        }
      }
    });
    updateProg();
  }catch(_){}
}

function clearAutosave(){ localStorage.removeItem(AUTOSAVE_KEY); }

// ======== ESTADO ========
let patient=null, tokenRow=null, CPF="";
let startAt = Date.now();

// ======== BOOT POR TOKEN ========
(async function boot(){
  try{
    const TOKEN=qs("token");
    if(!TOKEN){ setBox("#alert","Link inv√°lido (sem token). Solicite um novo link.","err"); return; }

    const trows=await sheetSearch(SHEETS.TOKENS,{ token:TOKEN });
    if(!trows?.length) throw new Error("Token inv√°lido ou expirado.");
    tokenRow=trows[0];
    const disabled=String(tokenRow.disabled||"n√£o").toLowerCase()==="sim";
    const expired = tokenRow.expires_at && (Date.parse(tokenRow.expires_at) < Date.now());
    if(disabled || expired) throw new Error("Token desativado/expirado. Pe√ßa um novo link.");

    CPF=onlyDigits(tokenRow.cpf||""); if(!CPF) throw new Error("Token sem CPF vinculado.");

    const prows=await sheetSearch(SHEETS.PATIENTS,{ cpf:CPF });
    if(!prows?.length) throw new Error("Paciente n√£o encontrado.");
    patient=prows[0];

    const allowed=String(patient[CODE]||"").toLowerCase()==="sim";
    if(!allowed){
      setBox("#alert","Este formul√°rio n√£o est√° liberado para voc√™. Entre em contato com o consult√≥rio.","err");
      return;
    }

    const flagDone=String(patient[`${CODE}_FEITO`]||"").toLowerCase()==="sim";
    const already=await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
    if(flagDone || (already && already.length)){
      setBox("#alert","Voc√™ j√° respondeu este formul√°rio. Voltando ao portal‚Ä¶","ok");
      setTimeout(goPortalWithToken,1200); return;
    }

    renderPatientInfo();
    renderQuestions();
    $("#pacInfo").style.display="grid";
    $("#form").style.display="block";
    hideBox("#alert");
    startAt=Date.now();
    restoreAutosave();

  }catch(err){
    console.error(err);
    setBox("#alert", err.message || "Falha ao abrir o formul√°rio. Tente novamente mais tarde.", "err");
  }
})();

function renderPatientInfo(){
  const g=$("#pacInfo"); g.innerHTML="";
  const info=[
    ["Nome",patient.nome||"-"],
    ["CPF",maskCPF(patient.cpf)],
    ["Nascimento",fmtDateISO(patient.data_nascimento)],
    ["E-mail",patient.email||"-"],
    ["WhatsApp",patient.whatsapp||"-"]
  ];
  for(const [k,v] of info){
    const d=document.createElement("div"); d.className="info";
    d.innerHTML=`<b>${k}</b><div>${v||"-"}</div>`;
    g.appendChild(d);
  }
}

// ======== SUBMIT ========
let sending=false;
$("#form").addEventListener("submit", async (e)=>{
  e.preventDefault();
  if(sending) return; sending=true; hideBox("#msg");
  const btn=$("#btnSubmit"); const originalText=btn.textContent; btn.disabled=true; btn.textContent="Enviando‚Ä¶";

  try{
    if(!patient) throw new Error("Sess√£o inv√°lida. Recarregue o link.");

 const answers = {};
const questionsObj = {};
let answeredCount = 0;

QUESTIONS.forEach((q, idx)=>{
  const n = idx + 1;
  const key = String(n).padStart(2,"0");   // "01","02","03"...
  const qn = `q${key}`;
  const stem = (typeof q === "string") ? q : q.text;

  if (typeof q === "string") {
    // PERGUNTA ABERTA (textarea)
    const el   = document.getElementById(qn);
    const raw  = (el?.value || "");
    const clean = sanitizeOneLine(raw);

    answers[qn] = raw;            // bruto no metrics
    if (clean) answeredCount++;

    questionsObj[key] = {
      stem,                       // texto da pergunta
      value: null,                // sem escore num√©rico na anamnese
      label: clean || "(sem resposta)" // resposta em texto
    };

  } else if (q.type === "checkbox") {
    // MULTIPLA ESCOLHA
    const vals = Array
      .from(document.querySelectorAll(`input[name="${qn}"]:checked`))
      .map(el => el.value);

    answers[qn] = vals;           // bruto no metrics
    const cleanVals = vals.map(v => sanitizeOneLine(v));
    const answerText = cleanVals.length
      ? cleanVals.join(", ")
      : "(nenhuma op√ß√£o marcada)";

    if (cleanVals.length) answeredCount++;

    questionsObj[key] = {
      stem,
      label: answerText           // todas as op√ß√µes marcadas em uma string
    };
  }
});

// Verifica duplicidade
const again = await sheetSearch(SHEETS.SCORES,{ cpf:CPF, code:CODE });
if(again && again.length){
  setBox("#msg","Este formul√°rio j√° foi enviado anteriormente. Voltando ao portal‚Ä¶","ok");
  setTimeout(goPortalWithToken,1000);
  return;
}

const durationSec = Math.round((Date.now()-startAt)/1000);

const row = {
  result_id:`${patient.cpf}_${CODE}_${Date.now()}`,
  token:qs("token"),
  cpf:patient.cpf,
  code:CODE,
  source:"paciente",
  submitted_at:new Date().toISOString(),
  total: answeredCount,
  // AGORA: JSON IGUAL AO PADR√ÉO QUE VOC√ä MOSTROU
  questions: JSON.stringify(questionsObj),
  // m√©tricas cruas, se voc√™ quiser usar depois
  metrics: JSON.stringify({
    answers,
    answeredCount,
    duration_sec: durationSec
  })
};

await sheetCreate(SHEETS.SCORES,row);
await sheetPatchBy(SHEETS.PATIENTS,"cpf",patient.cpf,{
  [`${CODE}_FEITO`]:"sim",
  [`${CODE}_FEITO_AT`]:new Date().toISOString()
});

clearAutosave();
setBox("#msg","Anamnese enviada. Retornando ao portal‚Ä¶","ok");
setTimeout(goPortalWithToken, 1300);

  }catch(err){
    console.error(err);
    setBox("#msg", err.message || "Falha ao enviar. Tente novamente.", "err");
    sending=false; btn.disabled=false; btn.textContent=originalText;
  }
});
</script>
</body>
</html>
